<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Loan Requests – Nexa Bank Admin</title>

    <style>
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #071739; color: white; }
        .top-bar { padding: 20px 40px; display: flex; justify-content: space-between; align-items: center; }
        .top-bar h1 { color: #f5c542; font-size: 28px; margin: 0; }
        .back-btn { background: #f5c542; color: #071739; padding: 10px 20px; border-radius: 10px; font-weight: bold; text-decoration: none; }
        table { width: 100%; border-collapse: collapse; background: #0e1e40; margin-top: 20px; border-radius: 12px; overflow: hidden; }
        th, td { padding: 14px; text-align: left; }
        th { background: #12264d; color: #f5c542; }
        tr:hover { background: #1a2f55; }
        .badge { padding: 6px 10px; border-radius: 8px; color: white; font-weight: bold; }
        .pending { background: #f5c542; color: black; }
        .approved { background: #16c784; }
        .disbursed { background: #16c784; }
        .rejected { background: #ff4d4d; }
        .btn { padding: 6px 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }
        .approve-btn { background: #16c784; color: black; }
        .reject-btn { background: #ff4d4d; color: white; }

        /* BACKDROP */
        #reasonModal {
            display:none;
            position:fixed;
            top:0; left:0;
            width:100%; height:100%;
            background:rgba(0,0,0,0.65);
            justify-content:center;
            align-items:center;
            z-index: 9999;
        }

        /* MODAL BOX */
        .modal-box {
            background:#0d1b3d;
            border:2px solid #f5c542;
            padding:25px;
            width:420px;
            border-radius:14px;
            color:white;
            box-shadow:0 0 20px rgba(245,197,66,0.4);
            animation: pop 0.2s ease-out;
        }

        @keyframes pop {
            from { transform:scale(0.8); opacity:0; }
            to { transform:scale(1); opacity:1; }
        }

        .modal-box h3 {
            margin-top:0;
            margin-bottom:15px;
            font-size:22px;
            color:#f5c542;
            text-align:center;
        }

        .modal-select, .modal-textarea {
            width:100%;
            padding:10px;
            border-radius:8px;
            border:1px solid #f5c542;
            background:#12264d;
            color:white;
            margin-bottom:12px;
            font-size:14px;
        }

        .modal-textarea { height:90px; display:none; }

        .modal-btn {
            padding:10px 18px;
            border:none;
            border-radius:8px;
            font-weight:bold;
            cursor:pointer;
            margin-right:10px;
        }

        .cancel-btn {
            background:#888;
            color:#fff;
        }

        .submit-btn {
            background:#f5c542;
            color:#0d1b3d;
        }
    </style>
</head>

<body>

<div class="top-bar">
    <h1>All Loan Requests</h1>
    <a class="back-btn" href="/admin-dashboard">← Dashboard</a>
</div>

<table>
    <thead>
    <tr>
        <th>Account Number</th>
        <th>Loan Type</th>
        <th>Amount</th>
        <th>Tenure</th>
        <th>Interest</th>
        <th>EMI</th>
        <th>Status</th>
        <th>Action</th>
    </tr>
    </thead>

    <tbody>
    <tr th:each="loan : ${loanList}">
        <td th:text="${loan.accountNumber}"></td>
        <td th:text="${loan.loanType}"></td>
        <td>₹<span th:text="${loan.amount}"></span></td>
        <td th:text="${loan.tenure} + ' months'"></td>
        <td th:text="${loan.interestRate} + '%'"></td>
        <td>₹<span th:text="${loan.emiAmount}"></span></td>

        <td>
            <span class="badge pending" th:if="${loan.status.name() == 'PENDING'}">PENDING</span>
            <span class="badge approved" th:if="${loan.status.name() == 'APPROVED'}">APPROVED</span>
            <span class="badge disbursed" th:if="${loan.status.name() == 'DISBURSED'}">DISBURSED</span>
            <span class="badge rejected" th:if="${loan.status.name() == 'REJECTED'}">REJECTED</span>
        </td>

        <td>
            <span th:if="${loan.status.name() != 'PENDING'}">—</span>

            <button th:if="${loan.status.name() == 'PENDING'}"
                    class="btn approve-btn"
                    th:onclick="|openModal('APPROVE', ${loan.id})|">
                Approve
            </button>

            <button th:if="${loan.status.name() == 'PENDING'}"
                    class="btn reject-btn"
                    th:onclick="|openModal('REJECT', ${loan.id})|">
                Reject
            </button>
        </td>
    </tr>
    </tbody>
</table>



<!-- ************* FINAL BLUE–GOLD MODAL ************* -->
<div id="reasonModal">
    <div class="modal-box">
        <h3 id="modalTitle"></h3>

        <select id="reasonDropdown" class="modal-select" onchange="toggleOtherReason()">
            <option value="">-- Select a reason --</option>

            <!-- Approve options -->
            <option value="Verified & Approved" class="approve-option">Verified & Approved</option>
            <option value="Income Criteria Met" class="approve-option">Income Criteria Met</option>
            <option value="Documents Verified" class="approve-option">Documents Verified</option>

            <!-- Reject options -->
            <option value="Low Credit Score" class="reject-option">Low Credit Score</option>
            <option value="Incomplete Documents" class="reject-option">Incomplete Documents</option>
            <option value="Failed Verification" class="reject-option">Failed Verification</option>

            <option value="other">Other</option>
        </select>

        <textarea id="reasonInput" class="modal-textarea" placeholder="Enter reason"></textarea>

        <div style="margin-top:15px; text-align:right;">
            <button class="modal-btn cancel-btn" onclick="closeModal()">Cancel</button>
            <button class="modal-btn submit-btn" onclick="submitLoanAction()">Submit</button>
        </div>
    </div>
</div>


<script>
    let currentLoanId = null;
    let currentAction = null;
function openModal(action, loanId) {
    currentLoanId = loanId;
    currentAction = action;

    document.getElementById("modalTitle").innerText =
        action === "APPROVE" ? "Approve Loan" : "Reject Loan";

    document.getElementById("reasonDropdown").value = "";
    document.getElementById("reasonInput").style.display = "none";
    document.getElementById("reasonInput").value = "";

    // First hide all options
    document.querySelectorAll(".approve-option, .reject-option").forEach(opt => {
        opt.style.display = "none";
    });

    // Show only relevant options
    if (action === "APPROVE") {
        document.querySelectorAll(".approve-option").forEach(opt => {
            opt.style.display = "block";
        });
    } else {
        document.querySelectorAll(".reject-option").forEach(opt => {
            opt.style.display = "block";
        });
    }

    // Always show "Other"
    document.querySelector("option[value='other']").style.display = "block";

    document.getElementById("reasonModal").style.display = "flex";
}


    function toggleOtherReason() {
        const dropdown = document.getElementById("reasonDropdown");
        const textarea = document.getElementById("reasonInput");
        textarea.style.display = dropdown.value === "other" ? "block" : "none";
    }

    function closeModal() {
        document.getElementById("reasonDropdown").value = "";
        document.getElementById("reasonInput").value = "";
        document.getElementById("reasonModal").style.display = "none";
    }

    function submitLoanAction() {
        const dropdownValue = document.getElementById("reasonDropdown").value;
        const otherText = document.getElementById("reasonInput").value.trim();

        let finalReason = dropdownValue === "other" ? otherText : dropdownValue;

        if (!finalReason || finalReason.trim() === "") {
            alert("Please select or enter a reason!");
            return;
        }

        const form = document.createElement("form");
        form.method = "post";

        form.action = currentAction === "APPROVE"
            ? "/admin/loans/approve"
            : "/admin/loans/reject";

        let loanIdInput = document.createElement("input");
        loanIdInput.type = "hidden";
        loanIdInput.name = "loanId";
        loanIdInput.value = currentLoanId;

        let reasonInput = document.createElement("input");
        reasonInput.type = "hidden";
        reasonInput.name = "reason";
        reasonInput.value = finalReason;

        form.appendChild(loanIdInput);
        form.appendChild(reasonInput);

        document.body.appendChild(form);
        form.submit();
    }
</script>

</body>
</html>
